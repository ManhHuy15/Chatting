<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData["Title"] - WebClient</title>
    <link rel="stylesheet" href="~/lib/bootstrap/dist/css/bootstrap.min.css" />
    <link rel="stylesheet" href="~/css/site.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/WebClient.styles.css" asp-append-version="true" />
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
          rel="stylesheet" />
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700&display=swap"
          rel="stylesheet" />
    <!-- MDB -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/mdb-ui-kit/9.0.0/mdb.min.css"
          rel="stylesheet" />
</head>
<body class="mb-0">
    <div>
        @RenderBody()
    </div>
    <script src="~/lib/jquery/dist/jquery.min.js"></script>
    <script src="~/lib/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
    <script src="~/js/site.js" asp-append-version="true"  ></script>
    <script src="~/js/jwt-refresh.js" asp-append-version="true"></script>
    <!-- MDB -->
    <script type="text/javascript"
            src="https://cdnjs.cloudflare.com/ajax/libs/mdb-ui-kit/9.0.0/mdb.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-validate/1.19.1/jquery.validate.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-validation-unobtrusive/3.2.11/jquery.validate.unobtrusive.min.js"></script>
    @* <script>
        $(document).on("ajaxSend", function (event, jqxhr, settings) {
            console.log(settings.url);
            if (settings.url === '/api/auth/refresh-token') {
                return;
            }
            var token = localStorage.getItem('access-token');
            console.log(token);
            if (token) {
                if (isTokenExpired(token)) {
                    refreshToken();
                    console.log('token expired');
                }
                jqxhr.setRequestHeader('Authorization', 'Bearer ' + token);
            }
        });

        function isTokenExpired(token) {
            try {
                const payload = JSON.parse(atob(token.split('.')[1]));
                const currentTime = Math.floor(Date.now() / 1000);
                return payload.exp < currentTime;
            } catch (e) {
                return true;
            }
        }

        function refreshToken() {
            return $.ajax({
                url: '/api/auth/refresh-token',
                method: 'POST',
                data: {
                    refreshToken: localStorage.getItem('refresh-token')
                }
            }).then(function (response) {
                localStorage.setItem('refresh-token', response.data.refreshToken);
                localStorage.setItem('access-token', response.data.accessToken);
                localStorage.setItem('email', JSON.stringify(response.data.email));
            });
        }
    </script> *@
    @await RenderSectionAsync("Scripts", required: false)
</body>
</html>
